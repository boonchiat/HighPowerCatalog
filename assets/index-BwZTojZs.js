var e=Object.defineProperty,n=(n,t,a)=>((n,t,a)=>t in n?e(n,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):n[t]=a)(n,"symbol"!=typeof t?t+"":t,a);!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))n(e);new MutationObserver(e=>{for(const t of e)if("childList"===t.type)for(const e of t.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&n(e)}).observe(document,{childList:!0,subtree:!0})}function n(e){if(e.ep)return;e.ep=!0;const n=function(e){const n={};return e.integrity&&(n.integrity=e.integrity),e.referrerPolicy&&(n.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?n.credentials="include":"anonymous"===e.crossOrigin?n.credentials="omit":n.credentials="same-origin",n}(e);fetch(e.href,n)}}();class t{constructor(e){n(this,"startX",0),n(this,"startY",0),n(this,"startTime",0),n(this,"minSwipeDistance",50),n(this,"maxSwipeTime",500),n(this,"onSwipeLeft",null),n(this,"onSwipeRight",null),n(this,"onDoubleTap",null),n(this,"onTap",null),n(this,"lastTapTime",0),n(this,"lastTapX",0),n(this,"lastTapY",0),n(this,"doubleTapThreshold",300),n(this,"doubleTapDistance",50),e.addEventListener("touchstart",this.handleTouchStart.bind(this),!1),e.addEventListener("touchend",this.handleTouchEnd.bind(this),!1),e.addEventListener("touchmove",this.handleTouchMove.bind(this),!1)}handleTouchStart(e){const n=e.touches[0];this.startX=n.clientX,this.startY=n.clientY,this.startTime=Date.now()}handleTouchMove(e){Math.abs(e.touches[0].clientX-this.startX)>10&&e.preventDefault()}handleTouchEnd(e){var n,t,a,i;const o=e.changedTouches[0].clientX,s=e.changedTouches[0].clientY,r=Date.now(),d=o-this.startX,c=s-this.startY,l=r-this.startTime;if(Math.abs(d)>this.minSwipeDistance&&Math.abs(c)<this.minSwipeDistance&&l<this.maxSwipeTime)return void(d>0?null==(n=this.onSwipeRight)||n.call(this):null==(t=this.onSwipeLeft)||t.call(this));const h=Date.now(),g=h-this.lastTapTime,u=Math.sqrt(Math.pow(o-this.lastTapX,2)+Math.pow(s-this.lastTapY,2));g<this.doubleTapThreshold&&u<this.doubleTapDistance?(null==(a=this.onDoubleTap)||a.call(this),this.lastTapTime=0):(null==(i=this.onTap)||i.call(this),this.lastTapTime=h,this.lastTapX=o,this.lastTapY=s)}}const a="flipbook-cache-";class i{constructor(){n(this,"cacheState",{isOfflineReady:!1,isCaching:!1,cacheProgress:0}),n(this,"stateChangeCallbacks",[]),this.checkOfflineStatus()}async checkOfflineStatus(){if("caches"in window)try{const e=await caches.keys();e.some(e=>e.startsWith(a))&&this.updateState({isOfflineReady:!0})}catch(e){console.error("Error checking cache status:",e)}}async downloadBookForOffline(e){if("caches"in window){this.updateState({isCaching:!0,cacheProgress:0});try{const t=`${a}${e.id}`,i=await caches.open(t),o=`/HighPowerCatalog/books/${e.id}/manifest.json`;await i.add(o);const s=2*e.pages.length;let r=0;for(const a of e.pages){const t=`/HighPowerCatalog/books/${e.id}/${a.image}`,o=`/HighPowerCatalog/books/${e.id}/${a.thumbnail}`;try{await i.add(t),r++,this.updateState({cacheProgress:Math.round(r/s*100)})}catch(n){console.warn(`Failed to cache page: ${t}`,n)}try{await i.add(o),r++,this.updateState({cacheProgress:Math.round(r/s*100)})}catch(n){console.warn(`Failed to cache thumbnail: ${o}`,n)}}if(e.coverImage){const t=`/HighPowerCatalog/books/${e.id}/${e.coverImage}`;try{await i.add(t)}catch(n){console.warn(`Failed to cache cover: ${t}`,n)}}this.updateState({isOfflineReady:!0,isCaching:!1,cacheProgress:100})}catch(n){console.error("Error downloading book for offline:",n),this.updateState({isCaching:!1})}}else console.warn("Cache API not available")}async getOfflineBookIds(){if(!("caches"in window))return[];try{return(await caches.keys()).filter(e=>e.startsWith(a)).map(e=>e.replace(a,""))}catch(e){return console.error("Error getting offline books:",e),[]}}async deleteOfflineBook(e){if("caches"in window)try{const n=`${a}${e}`;await caches.delete(n),this.updateState({isOfflineReady:!1})}catch(n){console.error("Error deleting offline book:",n)}}onStateChange(e){return this.stateChangeCallbacks.push(e),()=>{this.stateChangeCallbacks=this.stateChangeCallbacks.filter(n=>n!==e)}}updateState(e){this.cacheState={...this.cacheState,...e},this.stateChangeCallbacks.forEach(e=>e(this.cacheState))}getState(){return{...this.cacheState}}}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/HighPowerCatalog/sw.js").then(e=>{console.log("Service Worker registered:",e)}).catch(e=>{console.warn("Service Worker registration failed:",e)})});const o=new class{constructor(e,t="/HighPowerCatalog/"){n(this,"container"),n(this,"manifest",null),n(this,"currentPageIndex",0),n(this,"gestureHandler",null),n(this,"cacheManager"),n(this,"isLoading",!1),n(this,"baseUrl");const a=document.getElementById(e);if(!a)throw new Error(`Container with id "${e}" not found`);this.container=a,this.baseUrl=t,this.cacheManager=new i,this.setupContainer()}setupContainer(){this.container.innerHTML='\n      <div class="flipbook-viewer">\n        <div class="flipbook-header">\n          <button class="btn-menu" id="btnMenu" title="Menu">☰</button>\n          <h1 class="flipbook-title" id="bookTitle">Loading...</h1>\n          <button class="btn-download" id="btnDownload" title="Download for Offline">⬇</button>\n        </div>\n        \n        <div class="flipbook-content" id="flipbookContent">\n          <div class="page-container" id="pageContainer">\n            <img class="page-image" id="pageImage" alt="Book page" />\n          </div>\n          <div class="page-controls">\n            <button class="btn-prev" id="btnPrev">← Previous</button>\n            <span class="page-counter" id="pageCounter">Page 1 of 1</span>\n            <button class="btn-next" id="btnNext">Next →</button>\n          </div>\n        </div>\n\n        <div class="flipbook-sidebar" id="sidebar">\n          <div class="sidebar-header">\n            <h2>Thumbnails</h2>\n            <button class="btn-close-sidebar" id="btnCloseSidebar">✕</button>\n          </div>\n          <div class="thumbnail-grid" id="thumbnailGrid"></div>\n        </div>\n\n        <div class="cache-status" id="cacheStatus"></div>\n      </div>\n    ',this.attachEventListeners(),this.setupStyles()}setupStyles(){const e=document.createElement("style");e.textContent="\n      .flipbook-viewer {\n        display: flex;\n        flex-direction: column;\n        height: 100vh;\n        background: #1a1a1a;\n        color: #fff;\n      }\n\n      .flipbook-header {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 12px 16px;\n        background: #0d0d0d;\n        border-bottom: 1px solid #333;\n        gap: 12px;\n      }\n\n      .flipbook-title {\n        flex: 1;\n        font-size: 18px;\n        font-weight: 600;\n        text-align: center;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n      }\n\n      .btn-menu, .btn-download, .btn-close-sidebar {\n        background: #333;\n        border: none;\n        color: #fff;\n        padding: 8px 12px;\n        border-radius: 4px;\n        cursor: pointer;\n        font-size: 16px;\n        transition: background 0.2s;\n      }\n\n      .btn-menu:hover, .btn-download:hover, .btn-close-sidebar:hover {\n        background: #555;\n      }\n\n      .btn-download.cached {\n        background: #4caf50;\n      }\n\n      .flipbook-content {\n        flex: 1;\n        display: flex;\n        flex-direction: column;\n        overflow: hidden;\n        position: relative;\n      }\n\n      .page-container {\n        flex: 1;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        overflow: auto;\n        background: #000;\n        user-select: none;\n      }\n\n      .page-image {\n        max-width: 100%;\n        max-height: 100%;\n        object-fit: contain;\n        cursor: grab;\n      }\n\n      .page-image:active {\n        cursor: grabbing;\n      }\n\n      .page-controls {\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 16px;\n        padding: 12px 16px;\n        background: #0d0d0d;\n        border-top: 1px solid #333;\n      }\n\n      .btn-prev, .btn-next {\n        background: #333;\n        border: none;\n        color: #fff;\n        padding: 8px 16px;\n        border-radius: 4px;\n        cursor: pointer;\n        font-size: 14px;\n        transition: background 0.2s;\n      }\n\n      .btn-prev:hover, .btn-next:hover {\n        background: #555;\n      }\n\n      .btn-prev:disabled, .btn-next:disabled {\n        background: #222;\n        color: #666;\n        cursor: not-allowed;\n      }\n\n      .page-counter {\n        min-width: 120px;\n        text-align: center;\n        font-size: 14px;\n        color: #aaa;\n      }\n\n      .flipbook-sidebar {\n        position: fixed;\n        top: 0;\n        right: -300px;\n        width: 300px;\n        height: 100vh;\n        background: #0d0d0d;\n        border-left: 1px solid #333;\n        display: flex;\n        flex-direction: column;\n        transition: right 0.3s ease;\n        z-index: 1000;\n      }\n\n      .flipbook-sidebar.open {\n        right: 0;\n      }\n\n      .sidebar-header {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 12px 16px;\n        border-bottom: 1px solid #333;\n      }\n\n      .sidebar-header h2 {\n        font-size: 16px;\n        margin: 0;\n      }\n\n      .thumbnail-grid {\n        flex: 1;\n        overflow-y: auto;\n        padding: 8px;\n        display: grid;\n        grid-template-columns: 1fr;\n        gap: 8px;\n      }\n\n      .thumbnail {\n        aspect-ratio: 2/3;\n        background: #1a1a1a;\n        border: 2px solid #333;\n        border-radius: 4px;\n        cursor: pointer;\n        overflow: hidden;\n        transition: border-color 0.2s;\n      }\n\n      .thumbnail:hover {\n        border-color: #666;\n      }\n\n      .thumbnail.active {\n        border-color: #4caf50;\n      }\n\n      .thumbnail img {\n        width: 100%;\n        height: 100%;\n        object-fit: contain;\n        background: #0d0d0d;\n      }\n\n      .cache-status {\n        position: fixed;\n        bottom: 20px;\n        left: 20px;\n        background: #333;\n        padding: 12px 16px;\n        border-radius: 4px;\n        font-size: 12px;\n        max-width: 200px;\n        z-index: 500;\n        display: none;\n      }\n\n      .cache-status.show {\n        display: block;\n      }\n\n      .cache-status.success {\n        background: #4caf50;\n      }\n\n      .cache-status.error {\n        background: #f44336;\n      }\n\n      @media (max-width: 768px) {\n        .flipbook-title {\n          font-size: 16px;\n        }\n\n        .page-controls {\n          gap: 8px;\n          padding: 8px;\n        }\n\n        .btn-prev, .btn-next {\n          padding: 6px 12px;\n          font-size: 12px;\n        }\n\n        .page-counter {\n          font-size: 12px;\n        }\n      }\n    ",document.head.appendChild(e)}attachEventListeners(){const e=document.getElementById("btnMenu"),n=document.getElementById("btnDownload"),a=document.getElementById("btnPrev"),i=document.getElementById("btnNext"),o=document.getElementById("btnCloseSidebar"),s=document.getElementById("pageContainer");null==e||e.addEventListener("click",()=>this.toggleSidebar()),null==n||n.addEventListener("click",()=>this.downloadForOffline()),null==a||a.addEventListener("click",()=>this.previousPage()),null==i||i.addEventListener("click",()=>this.nextPage()),null==o||o.addEventListener("click",()=>this.toggleSidebar()),s&&(this.gestureHandler=new t(s),this.gestureHandler.onSwipeLeft=()=>this.nextPage(),this.gestureHandler.onSwipeRight=()=>this.previousPage()),this.cacheManager.onStateChange(e=>{this.updateCacheStatus(e)})}async loadBook(e){if(!this.isLoading){this.isLoading=!0;try{const n=`${this.baseUrl}books/${e}/manifest.json`,t=await fetch(n);if(!t.ok)throw new Error(`Failed to load manifest: ${t.statusText}`);this.manifest=await t.json(),console.log("Manifest loaded:",this.manifest),this.manifest.pages&&this.manifest.pages.length>0&&console.log("First page object:",this.manifest.pages[0]),this.currentPageIndex=0,this.renderPage(),this.renderThumbnails(),this.updateDownloadButton()}catch(n){console.error("Error loading book:",n),this.showError(`Failed to load book: ${e}`)}finally{this.isLoading=!1}}}renderPage(){if(!this.manifest)return void console.error("No manifest loaded");const e=this.manifest.pages[this.currentPageIndex];if(console.log("Current page index:",this.currentPageIndex),console.log("Page object:",e),!e)return void console.error("Page not found at index:",this.currentPageIndex);const n=document.getElementById("pageImage"),t=document.getElementById("pageCounter"),a=document.getElementById("bookTitle");n.src=`${this.baseUrl}books/${this.manifest.id}/${e.image}`,n.alt=`Page ${e.pageNumber}`,t&&(t.textContent=`Page ${e.pageNumber} of ${this.manifest.totalPages}`),a&&(a.textContent=this.manifest.title),this.updatePageControls()}renderThumbnails(){if(!this.manifest)return;const e=document.getElementById("thumbnailGrid");e&&(e.innerHTML="",this.manifest.pages.forEach((n,t)=>{const a=document.createElement("div");a.className="thumbnail",t===this.currentPageIndex&&a.classList.add("active");const i=document.createElement("img");i.src=`${this.baseUrl}books/${this.manifest.id}/${n.thumbnail}`,i.alt=`Thumbnail page ${n.pageNumber}`,i.loading="lazy",a.appendChild(i),a.addEventListener("click",()=>{this.currentPageIndex=t,this.renderPage(),this.renderThumbnails()}),e.appendChild(a)}))}updatePageControls(){if(!this.manifest)return;const e=document.getElementById("btnPrev"),n=document.getElementById("btnNext");e&&(e.disabled=0===this.currentPageIndex),n&&(n.disabled=this.currentPageIndex===this.manifest.pages.length-1)}nextPage(){this.manifest&&this.currentPageIndex<this.manifest.pages.length-1&&(this.currentPageIndex++,this.renderPage(),this.renderThumbnails())}previousPage(){this.currentPageIndex>0&&(this.currentPageIndex--,this.renderPage(),this.renderThumbnails())}toggleSidebar(){const e=document.getElementById("sidebar");null==e||e.classList.toggle("open")}async downloadForOffline(){this.manifest&&await this.cacheManager.downloadBookForOffline(this.manifest)}updateDownloadButton(){const e=document.getElementById("btnDownload");if(!e)return;this.cacheManager.getState().isOfflineReady?(e.classList.add("cached"),e.textContent="✓",e.title="Downloaded for offline"):(e.classList.remove("cached"),e.textContent="⬇",e.title="Download for offline")}updateCacheStatus(e){const n=document.getElementById("cacheStatus");n&&(e.isCaching?(n.classList.add("show"),n.textContent=`Caching... ${e.cacheProgress}%`,n.classList.remove("success","error")):e.isOfflineReady&&(n.classList.add("show","success"),n.textContent="Offline Ready ✓",setTimeout(()=>{n.classList.remove("show")},3e3),this.updateDownloadButton()))}showError(e){const n=document.getElementById("cacheStatus");n&&(n.classList.add("show","error"),n.textContent=e)}}("app","/HighPowerCatalog/"),s=new URLSearchParams(window.location.search).get("book")||"catalog_11-12-25";o.loadBook(s).catch(e=>{console.error("Failed to load book:",e)});
