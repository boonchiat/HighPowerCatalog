var e=Object.defineProperty,n=(n,t,a)=>((n,t,a)=>t in n?e(n,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):n[t]=a)(n,"symbol"!=typeof t?t+"":t,a);!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))n(e);new MutationObserver(e=>{for(const t of e)if("childList"===t.type)for(const e of t.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&n(e)}).observe(document,{childList:!0,subtree:!0})}function n(e){if(e.ep)return;e.ep=!0;const n=function(e){const n={};return e.integrity&&(n.integrity=e.integrity),e.referrerPolicy&&(n.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?n.credentials="include":"anonymous"===e.crossOrigin?n.credentials="omit":n.credentials="same-origin",n}(e);fetch(e.href,n)}}();class t{constructor(e){n(this,"startX",0),n(this,"startY",0),n(this,"startTime",0),n(this,"minSwipeDistance",50),n(this,"maxSwipeTime",500),n(this,"onSwipeLeft",null),n(this,"onSwipeRight",null),n(this,"onDoubleTap",null),n(this,"onTap",null),n(this,"lastTapTime",0),n(this,"lastTapX",0),n(this,"lastTapY",0),n(this,"doubleTapThreshold",300),n(this,"doubleTapDistance",50),e.addEventListener("touchstart",this.handleTouchStart.bind(this),!1),e.addEventListener("touchend",this.handleTouchEnd.bind(this),!1),e.addEventListener("touchmove",this.handleTouchMove.bind(this),!1)}handleTouchStart(e){const n=e.touches[0];this.startX=n.clientX,this.startY=n.clientY,this.startTime=Date.now()}handleTouchMove(e){Math.abs(e.touches[0].clientX-this.startX)>10&&e.preventDefault()}handleTouchEnd(e){var n,t,a,i;const s=e.changedTouches[0].clientX,o=e.changedTouches[0].clientY,r=Date.now(),d=s-this.startX,l=o-this.startY,c=r-this.startTime;if(Math.abs(d)>this.minSwipeDistance&&Math.abs(l)<this.minSwipeDistance&&c<this.maxSwipeTime)return void(d>0?null==(n=this.onSwipeRight)||n.call(this):null==(t=this.onSwipeLeft)||t.call(this));const h=Date.now(),g=h-this.lastTapTime,p=Math.sqrt(Math.pow(s-this.lastTapX,2)+Math.pow(o-this.lastTapY,2));g<this.doubleTapThreshold&&p<this.doubleTapDistance?(null==(a=this.onDoubleTap)||a.call(this),this.lastTapTime=0):(null==(i=this.onTap)||i.call(this),this.lastTapTime=h,this.lastTapX=s,this.lastTapY=o)}}class a{constructor(){n(this,"state",{isOfflineReady:!1,isCaching:!1,cacheProgress:0}),n(this,"stateChangeCallbacks",[]),n(this,"baseUrl","/HighPowerCatalog/"),this.checkCacheStatus()}async checkCacheStatus(){if("serviceWorker"in navigator)try{await navigator.serviceWorker.ready;console.log("Service Worker ready for offline support")}catch(e){console.warn("Service Worker not available:",e)}}async cacheBook(e){if(!("serviceWorker"in navigator)||!navigator.serviceWorker.controller)throw new Error("Service Worker not available");return new Promise((n,t)=>{const a=new MessageChannel;navigator.serviceWorker.controller.postMessage({type:"CACHE_BOOK",bookId:e.id,pages:e.pages},[a.port2]),a.port1.onmessage=e=>{"CACHE_COMPLETE"===e.data.type?(e.data.success?(this.setState({isOfflineReady:!0,isCaching:!1,cacheProgress:100}),n()):t(new Error(e.data.error||"Caching failed")),a.port1.close()):"CACHE_PROGRESS"===e.data.type&&this.setState({isCaching:!0,cacheProgress:Math.round(e.data.cached/e.data.total*100)})},setTimeout(()=>{a.port1.close(),t(new Error("Caching timeout"))},3e5)})}async isBookCached(e){if(!("caches"in window))return!1;try{const n=await caches.open("flipbook-runtime-v1"),t=`${this.baseUrl}books/${e}/manifest.json`;return!!(await n.match(t))}catch(n){return console.error("Error checking cache:",n),!1}}async clearCache(){if("caches"in window)try{const e=await caches.keys();await Promise.all(e.map(e=>caches.delete(e))),this.setState({isOfflineReady:!1,isCaching:!1,cacheProgress:0})}catch(e){console.error("Error clearing cache:",e)}}setState(e){this.state={...this.state,...e},this.stateChangeCallbacks.forEach(e=>e(this.state))}onStateChange(e){this.stateChangeCallbacks.push(e)}getState(){return{...this.state}}}"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/HighPowerCatalog/sw.js").then(e=>{console.log("Service Worker registered:",e)}).catch(e=>{console.warn("Service Worker registration failed:",e)})});const i=new class{constructor(e,t="/HighPowerCatalog/"){n(this,"container"),n(this,"manifest",null),n(this,"currentPageIndex",0),n(this,"gestureHandler",null),n(this,"cacheManager"),n(this,"isLoading",!1),n(this,"baseUrl"),n(this,"zoom",1),n(this,"panX",0),n(this,"panY",0),n(this,"isPanning",!1),n(this,"panStartX",0),n(this,"panStartY",0),n(this,"loadedPages",new Map),n(this,"pageCache",new Map);const i=document.getElementById(e);if(!i)throw new Error(`Container with id "${e}" not found`);this.container=i,this.baseUrl=t,this.cacheManager=new a,this.setupContainer()}setupContainer(){this.container.innerHTML='\n      <div class="flipbook-viewer">\n        <div class="flipbook-header">\n          <button class="btn-menu" id="btnMenu" title="Menu">☰</button>\n          <h1 class="flipbook-title" id="bookTitle">Loading...</h1>\n          <button class="btn-download" id="btnDownload" title="Download for Offline">⬇</button>\n        </div>\n        \n        <div class="flipbook-content" id="flipbookContent">\n          <div class="zoom-controls">\n            <button class="btn-zoom" id="btnZoomOut" title="Zoom Out">−</button>\n            <span class="zoom-level" id="zoomLevel">100%</span>\n            <button class="btn-zoom" id="btnZoomIn" title="Zoom In">+</button>\n            <button class="btn-zoom" id="btnFitWidth" title="Fit to Width">⊡</button>\n          </div>\n          \n          <div class="page-container" id="pageContainer">\n            <div class="page-viewer" id="pageViewer">\n              <img class="page-image" id="pageImage" alt="Book page" />\n            </div>\n          </div>\n          \n          <div class="page-controls">\n            <button class="btn-prev" id="btnPrev">← Previous</button>\n            <span class="page-counter" id="pageCounter">Page 1 of 1</span>\n            <button class="btn-next" id="btnNext">Next →</button>\n          </div>\n        </div>\n\n        <div class="flipbook-sidebar" id="sidebar">\n          <div class="sidebar-header">\n            <h2>Thumbnails</h2>\n            <button class="btn-close-sidebar" id="btnCloseSidebar">✕</button>\n          </div>\n          <div class="thumbnail-grid" id="thumbnailGrid"></div>\n        </div>\n\n        <div class="cache-status" id="cacheStatus"></div>\n        <div class="offline-message" id="offlineMessage"></div>\n      </div>\n    ',this.attachEventListeners(),this.setupStyles(),this.checkOfflineStatus()}setupStyles(){const e=document.createElement("style");e.textContent="\n      .flipbook-viewer {\n        display: flex;\n        flex-direction: column;\n        height: 100vh;\n        background: #1a1a1a;\n        color: #fff;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      }\n\n      .flipbook-header {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 12px 16px;\n        background: #0d0d0d;\n        border-bottom: 1px solid #333;\n        gap: 12px;\n        z-index: 100;\n      }\n\n      .flipbook-title {\n        flex: 1;\n        font-size: 18px;\n        font-weight: 600;\n        text-align: center;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        margin: 0;\n      }\n\n      .btn-menu, .btn-download, .btn-close-sidebar, .btn-zoom {\n        background: #333;\n        border: none;\n        color: #fff;\n        padding: 8px 12px;\n        border-radius: 4px;\n        cursor: pointer;\n        font-size: 16px;\n        transition: background 0.2s;\n      }\n\n      .btn-menu:hover, .btn-download:hover, .btn-close-sidebar:hover, .btn-zoom:hover {\n        background: #555;\n      }\n\n      .flipbook-content {\n        flex: 1;\n        display: flex;\n        flex-direction: column;\n        overflow: hidden;\n        position: relative;\n      }\n\n      .zoom-controls {\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 8px;\n        padding: 8px;\n        background: #0d0d0d;\n        border-bottom: 1px solid #333;\n      }\n\n      .zoom-level {\n        font-size: 12px;\n        min-width: 50px;\n        text-align: center;\n      }\n\n      .page-container {\n        flex: 1;\n        overflow: auto;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: #0d0d0d;\n        position: relative;\n      }\n\n      .page-viewer {\n        position: relative;\n        display: inline-flex;\n        align-items: center;\n        justify-content: center;\n        cursor: grab;\n        user-select: none;\n        transform-origin: center;\n        transition: transform 0.1s ease-out;\n      }\n\n      .page-viewer.panning {\n        cursor: grabbing;\n      }\n\n      .page-image {\n        max-width: 100%;\n        max-height: 100%;\n        display: block;\n        image-rendering: high-quality;\n        will-change: transform;\n      }\n\n      .page-controls {\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 16px;\n        padding: 12px;\n        background: #0d0d0d;\n        border-top: 1px solid #333;\n      }\n\n      .btn-prev, .btn-next {\n        background: #333;\n        border: none;\n        color: #fff;\n        padding: 8px 16px;\n        border-radius: 4px;\n        cursor: pointer;\n        font-size: 14px;\n        transition: background 0.2s;\n      }\n\n      .btn-prev:hover, .btn-next:hover {\n        background: #555;\n      }\n\n      .btn-prev:disabled, .btn-next:disabled {\n        opacity: 0.5;\n        cursor: not-allowed;\n      }\n\n      .page-counter {\n        font-size: 12px;\n        min-width: 100px;\n        text-align: center;\n      }\n\n      .flipbook-sidebar {\n        position: fixed;\n        left: -320px;\n        top: 0;\n        width: 300px;\n        height: 100vh;\n        background: #1a1a1a;\n        border-right: 1px solid #333;\n        transition: left 0.3s ease-out;\n        z-index: 200;\n        display: flex;\n        flex-direction: column;\n      }\n\n      .flipbook-sidebar.open {\n        left: 0;\n      }\n\n      .sidebar-header {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        padding: 12px;\n        border-bottom: 1px solid #333;\n      }\n\n      .sidebar-header h2 {\n        font-size: 16px;\n        margin: 0;\n      }\n\n      .thumbnail-grid {\n        flex: 1;\n        overflow-y: auto;\n        padding: 8px;\n        display: grid;\n        grid-template-columns: 1fr;\n        gap: 8px;\n      }\n\n      .thumbnail {\n        aspect-ratio: 2/3;\n        background: #0d0d0d;\n        border: 2px solid #333;\n        border-radius: 4px;\n        cursor: pointer;\n        overflow: hidden;\n        transition: border-color 0.2s;\n      }\n\n      .thumbnail:hover {\n        border-color: #666;\n      }\n\n      .thumbnail.active {\n        border-color: #4caf50;\n      }\n\n      .thumbnail img {\n        width: 100%;\n        height: 100%;\n        object-fit: contain;\n        background: #0d0d0d;\n      }\n\n      .cache-status {\n        position: fixed;\n        bottom: 20px;\n        left: 20px;\n        background: #333;\n        padding: 12px 16px;\n        border-radius: 4px;\n        font-size: 12px;\n        max-width: 200px;\n        z-index: 500;\n        display: none;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.3);\n      }\n\n      .cache-status.show {\n        display: block;\n        animation: slideIn 0.3s ease-out;\n      }\n\n      .cache-status.success {\n        background: #4caf50;\n        color: #fff;\n      }\n\n      .cache-status.error {\n        background: #f44336;\n        color: #fff;\n      }\n\n      .cache-status.info {\n        background: #2196f3;\n        color: #fff;\n      }\n\n      .offline-message {\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        background: #f44336;\n        color: #fff;\n        padding: 24px 32px;\n        border-radius: 8px;\n        text-align: center;\n        z-index: 600;\n        display: none;\n        max-width: 80%;\n        box-shadow: 0 4px 16px rgba(0,0,0,0.4);\n      }\n\n      .offline-message.show {\n        display: block;\n        animation: fadeIn 0.3s ease-out;\n      }\n\n      @keyframes slideIn {\n        from {\n          transform: translateX(-20px);\n          opacity: 0;\n        }\n        to {\n          transform: translateX(0);\n          opacity: 1;\n        }\n      }\n\n      @keyframes fadeIn {\n        from {\n          opacity: 0;\n        }\n        to {\n          opacity: 1;\n        }\n      }\n\n      @media (max-width: 768px) {\n        .flipbook-title {\n          font-size: 16px;\n        }\n\n        .page-controls {\n          gap: 8px;\n          padding: 8px;\n        }\n\n        .btn-prev, .btn-next {\n          padding: 6px 12px;\n          font-size: 12px;\n        }\n\n        .zoom-controls {\n          gap: 4px;\n          padding: 4px;\n        }\n\n        .btn-zoom {\n          padding: 6px 8px;\n          font-size: 14px;\n        }\n      }\n    ",document.head.appendChild(e)}attachEventListeners(){const e=document.getElementById("btnMenu"),n=document.getElementById("btnDownload"),a=document.getElementById("btnPrev"),i=document.getElementById("btnNext"),s=document.getElementById("btnCloseSidebar"),o=document.getElementById("pageContainer"),r=document.getElementById("pageViewer"),d=document.getElementById("btnZoomIn"),l=document.getElementById("btnZoomOut"),c=document.getElementById("btnFitWidth");null==e||e.addEventListener("click",()=>this.toggleSidebar()),null==n||n.addEventListener("click",()=>this.downloadForOffline()),null==a||a.addEventListener("click",()=>this.previousPage()),null==i||i.addEventListener("click",()=>this.nextPage()),null==s||s.addEventListener("click",()=>this.toggleSidebar()),null==d||d.addEventListener("click",()=>this.zoomIn()),null==l||l.addEventListener("click",()=>this.zoomOut()),null==c||c.addEventListener("click",()=>this.fitToWidth()),o&&(this.gestureHandler=new t(o),this.gestureHandler.onSwipeLeft=()=>this.nextPage(),this.gestureHandler.onSwipeRight=()=>this.previousPage()),r&&(r.addEventListener("mousedown",e=>this.startPan(e)),r.addEventListener("mousemove",e=>this.doPan(e)),r.addEventListener("mouseup",()=>this.endPan()),r.addEventListener("mouseleave",()=>this.endPan()),r.addEventListener("wheel",e=>this.handleWheel(e),{passive:!1})),this.cacheManager.onStateChange(e=>{this.updateCacheStatus(e)}),window.addEventListener("online",()=>this.checkOfflineStatus()),window.addEventListener("offline",()=>this.checkOfflineStatus())}async loadBook(e){if(!this.isLoading){this.isLoading=!0;try{const n=`${this.baseUrl}books/${e}/manifest.json`,t=await fetch(n);if(!t.ok)throw new Error(`Failed to load manifest: ${t.statusText}`);this.manifest=await t.json(),console.log("Manifest loaded:",this.manifest),this.manifest.pages&&this.manifest.pages.length>0&&console.log("First page object:",this.manifest.pages[0]),this.currentPageIndex=0,this.zoom=1,this.panX=0,this.panY=0,this.renderPage(),this.renderThumbnails(),this.updateDownloadButton()}catch(n){console.error("Error loading book:",n),this.showError(`Failed to load book: ${e}`)}finally{this.isLoading=!1}}}renderPage(){if(!this.manifest)return void console.error("No manifest loaded");const e=this.manifest.pages[this.currentPageIndex];if(console.log("Current page index:",this.currentPageIndex),console.log("Page object:",e),!e)return void console.error("Page not found at index:",this.currentPageIndex);const n=document.getElementById("pageImage"),t=document.getElementById("pageCounter"),a=document.getElementById("bookTitle");document.getElementById("pageViewer"),n.src=`${this.baseUrl}books/${this.manifest.id}/${e.image}`,n.alt=`Page ${e.pageNumber}`,t&&(t.textContent=`Page ${e.pageNumber} of ${this.manifest.totalPages}`),a&&(a.textContent=this.manifest.title),this.zoom=1,this.panX=0,this.panY=0,this.updatePageTransform(),this.updatePageControls(),this.preloadAdjacentPages()}renderThumbnails(){if(!this.manifest)return;const e=document.getElementById("thumbnailGrid");e&&(e.innerHTML="",this.manifest.pages.forEach((n,t)=>{const a=document.createElement("div");a.className="thumbnail",t===this.currentPageIndex&&a.classList.add("active");const i=document.createElement("img");i.src=`${this.baseUrl}books/${this.manifest.id}/${n.thumbnail}`,i.alt=`Thumbnail page ${n.pageNumber}`,i.loading="lazy",a.appendChild(i),a.addEventListener("click",()=>{this.currentPageIndex=t,this.renderPage(),this.renderThumbnails()}),e.appendChild(a)}))}preloadAdjacentPages(){if(this.manifest){if(this.currentPageIndex>0){const e=this.manifest.pages[this.currentPageIndex-1];(new Image).src=`${this.baseUrl}books/${this.manifest.id}/${e.image}`}if(this.currentPageIndex<this.manifest.pages.length-1){const e=this.manifest.pages[this.currentPageIndex+1];(new Image).src=`${this.baseUrl}books/${this.manifest.id}/${e.image}`}}}updatePageControls(){var e;const n=document.getElementById("btnPrev"),t=document.getElementById("btnNext");n&&(n.disabled=0===this.currentPageIndex),t&&(t.disabled=this.currentPageIndex===((null==(e=this.manifest)?void 0:e.pages.length)??1)-1)}nextPage(){this.manifest&&this.currentPageIndex<this.manifest.pages.length-1&&(this.currentPageIndex++,this.renderPage(),this.renderThumbnails())}previousPage(){this.currentPageIndex>0&&(this.currentPageIndex--,this.renderPage(),this.renderThumbnails())}toggleSidebar(){const e=document.getElementById("sidebar");null==e||e.classList.toggle("open")}zoomIn(){this.zoom=Math.min(this.zoom+.2,3),this.updatePageTransform()}zoomOut(){this.zoom=Math.max(this.zoom-.2,1),this.updatePageTransform()}fitToWidth(){const e=document.getElementById("pageContainer"),n=document.getElementById("pageImage");if(e&&n&&n.naturalWidth){const t=e.clientWidth;this.zoom=t/n.naturalWidth,this.updatePageTransform()}}startPan(e){if(this.zoom<=1)return;this.isPanning=!0,this.panStartX=e.clientX-this.panX,this.panStartY=e.clientY-this.panY;const n=document.getElementById("pageViewer");null==n||n.classList.add("panning")}doPan(e){!this.isPanning||this.zoom<=1||(this.panX=e.clientX-this.panStartX,this.panY=e.clientY-this.panStartY,this.updatePageTransform())}endPan(){this.isPanning=!1;const e=document.getElementById("pageViewer");null==e||e.classList.remove("panning")}handleWheel(e){(e.ctrlKey||e.metaKey)&&(e.preventDefault(),e.deltaY<0?this.zoomIn():this.zoomOut())}updatePageTransform(){const e=document.getElementById("pageViewer"),n=document.getElementById("zoomLevel");e&&(e.style.transform=`scale(${this.zoom}) translate(${this.panX/this.zoom}px, ${this.panY/this.zoom}px)`),n&&(n.textContent=`${Math.round(100*this.zoom)}%`)}async downloadForOffline(){if(!this.manifest)return;const e=document.getElementById("btnDownload");e&&(e.disabled=!0),this.showCacheStatus("Downloading…","info");try{await this.cacheManager.cacheBook(this.manifest),this.showCacheStatus("Offline Ready ✓","success"),e&&(e.textContent="✓")}catch(n){console.error("Failed to cache book:",n),this.showCacheStatus("Download failed","error")}}showCacheStatus(e,n){const t=document.getElementById("cacheStatus");t&&(t.textContent=e,t.className=`cache-status show ${n}`,"success"!==n&&"error"!==n||setTimeout(()=>{t.classList.remove("show")},3e3))}async checkOfflineStatus(){if(!navigator.onLine&&this.manifest){await this.cacheManager.isBookCached(this.manifest.id)||this.showOfflineMessage("Offline assets not downloaded yet. Please connect once.")}}showOfflineMessage(e){const n=document.getElementById("offlineMessage");n&&(n.textContent=e,n.classList.add("show"),setTimeout(()=>{n.classList.remove("show")},5e3))}updateCacheStatus(e){}showError(e){const n=document.getElementById("offlineMessage");n&&(n.textContent=e,n.classList.add("show"))}async updateDownloadButton(){if(!this.manifest)return;const e=document.getElementById("btnDownload");if(e)try{await this.cacheManager.isBookCached(this.manifest.id)?(e.textContent="✓",e.disabled=!0,e.title="Book is cached for offline"):(e.textContent="⬇",e.disabled=!1,e.title="Download for Offline")}catch(n){console.error("Error updating download button:",n)}}}("app","/HighPowerCatalog/"),s=new URLSearchParams(window.location.search).get("book")||"catalog_11-12-25";i.loadBook(s).catch(e=>{console.error("Failed to load book:",e)});
